C51 COMPILER V9.00   MCUFUNCTION                                                           07/12/2019 22:42:47 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MCUFUNCTION
OBJECT MODULE PLACED IN ..\output\mcufunction.obj
COMPILER INVOKED BY: E:\developer kit tool\Keil_v5\C51\BIN\C51.EXE ..\code\source\mcufunction.c LARGE OPTIMIZE(9,SIZE) B
                    -ROWSE NOAREGS INTVECTOR(0X0300) INCDIR(..\code\include) DEBUG OBJECTEXTEND PRINT(.\mcufunction.lst) TABS(2) OBJECT(..\ou
                    -tput\mcufunction.obj)

line level    source

   1          /*****************************************************************************
   2          **               AMICCOM Electronics Corporation Document                   **
   3          **          Copyright (c) 2011-2014 AMICCOM Electronics Corporation         **
   4          **                                                                          **
   5          **      A3,1F,No.1, Li-Hsin 1th Road, Science_Based Industrid Park,         **
   6          **                       Hsin_Chu City, 300, Taiwan, ROC.                   **
   7          **                 Tel: 886-3-5785818   Fax: 886-3-5785819                  **
   8          **         E-mail:info@amiccom.com.tw  http: //www.amiccom.com.tw           **
   9          *****************************************************************************/
  10          #include "define.h"
  11          #include "A8107.h"
  12          #include "LibFunction.h"
  13          
  14          /*********************************************************************
  15          ** Global Variables
  16          *********************************************************************/
  17          uint8_t xdata   auth_req;
  18          uint8_t xdata   init_req;
  19          uint8_t xdata   index;
  20          uint8_t xdata   auth_init_finish;
  21          uint8_t xdata   scale_index;
  22          uint8_t xdata   KeyWakeup;
  23          uint8_t xdata   scalebuf[10];
  24          uint16_t xdata  weightvalue;
  25          uint32_t xdata  datevalue;
  26          uint8_t xdata sendscaledata;
  27          uint8_t xdata waitpacket;
  28          //////////////////TWOR///////////////////////
  29          uint8_t xdata TworTimer;
  30          ///////////////////TWOR//////////////////////
  31          
  32          
  33          static const char ascii[] = "0123456789ABCDEF";
  34          
  35          void En_P30_Wakeup_Init(void);
  36          void En_P30_Wakeup_Enable(void);
  37          
  38          bit IntoSleepFlag = FALSE;
  39          bit RecoveryFlag  = FALSE;
  40          
  41          const uint8_t code send_scale_data[60]=
  42          {
  43              0x03,0x00,0x34,0xFE,0x01,0x00,0x34,0x27,
  44              0x12,0x00,0x00,0x0A,0x00,0x12,0x26,0x43,
  45              0x33,0x46,0x45,0x30,
  46              0x30,0x30,0x36,0x45,0x30,0x35,0x35,0x44,
  47              0x36,0x42,0x34,0x43,0x41,0x46,0x46,0x30,
  48              0x30,0x30,0x30,0x30,
  49              0x30,0x46,0x46,0x30,0x30,0x30,0x30,0x30,
  50              0x30,0x30,0x30,0x30,0x39,0x18,0x00,0x00,
  51              0x00,0x00,0x00,0x00
  52          };
  53          
C51 COMPILER V9.00   MCUFUNCTION                                                           07/12/2019 22:42:47 PAGE 2   

  54          
  55          void InitMCU(void);
  56          /*********************************************************************
  57          ** InitMCU
  58          *
  59          ******************************************************************************
  60          **  ROUTINE NAME: initMcu                                                   **
  61          **  I/O define  :                                                           **
  62          **     Bit|   7   |   6   |   5   |   4   |   3   |   2   |   1   |   0   | **
  63          **  Port 0|  P07  |  P06  |  P05  |  P04  |  P03  |  P02  |  P01  |  P00  | **
  64          **   I/O  | undef | undef | KEY(I)| undef | KEY(I)| KEY(I)| KEY(I)| KEY(I)| **
  65          **  Port 1|  P17  |  P16  |  P15  |  P14  |  P13  |  P12  |  P11  |  P10  | **
  66          **   I/O  | undef | undef | undef | undef | undef | undef | undef | undef | **
  67          **  Port 3|  P37  |  P36  |  P35  |  P34  |  P33  |  P32  |  P31  |  P30  | **
  68          **   I/O  | undef | undef | undef | undef | undef | undef | Tx(O) | Rx(I) | **
  69          ******************************************************************************
  70          *1.初始化P05(Vol+) P03(Vol-) P02(video) P01(invert) P00(capture)按键
  71          *2.初始化串口引脚 P30 P31
  72          *3.初始化系统时钟，使能引脚功能
  73          *4.清除RSFLAG寄存器标志
  74          *********************************************************************/
  75          void InitMCU(void)
  76          {
  77   1      /*
  78   1      ** Port 0/1/2
  79   1      ** OE  - 0:input     1:output
  80   1      ** PUN - 0:Pull-up   1:HZ
  81   1      ** WUn - 0:Wakeup    1:No Wakeup
  82   1      */
  83   1       //   P0    = 0xD5;
  84   1       //   P0OE  = 0xAF;
  85   1       //   P0PUN = 0xAF;
  86   1       //   P0WUN = 0xFF;
  87   1          P0 = 0xFF;
  88   1          P0OE = 0x00;
  89   1          P0PUN = 0x00;
  90   1          P0WUN = 0xFF;
  91   1          
  92   1          P1    = 0xFF;
  93   1          P1OE  = 0x0C;
  94   1          P1PUN = 0x0C;
  95   1          P1WUN = 0xFF;
  96   1          
  97   1          P3    = 0xFF;
  98   1          P3OE  = 0x02;
  99   1          P3PUN = 0x00;
 100   1          P3WUN = 0xFF;
 101   1          
 102   1          /*********************************************/
 103   1          /*    MCU Frequency setting (Dont Modify)    */
 104   1          PCONE |= 0x01;  //SYSCLK = 16MHz / 2 = 8MHz  */
 105   1          PCON  |= 0x01;  //Enable CKSE                */
 106   1          /*********************************************/
 107   1          RSFLAG = 0x07; /* 清除LVDF,RESETNF,PORF重启标志 */
 108   1          check_stable = 0x5AA5;
 109   1      }
 110          
 111          bit isIntoSleep(void)
 112          {
 113   1          return IntoSleepFlag;
 114   1      }
 115          
C51 COMPILER V9.00   MCUFUNCTION                                                           07/12/2019 22:42:47 PAGE 3   

 116          void setIntoSleepFlag(bit enable)
 117          {
 118   1          IntoSleepFlag = enable;
 119   1      }
 120          
 121          void En_Recovery(void)
 122          {
 123   1          //使能0.5s定时
 124   1          Twor05Timer(ENABLE);
 125   1      }
 126          
 127          /* 休眠 */
 128          void En_Sleep(void)
 129          {
 130   1        ADV_InitDef ADV_InitStructure;
 131   1      
 132   1          //禁止广播
 133   1        ADV_InitStructure.ADV_RndEnable = DISABLE;
 134   1        ADV_InitStructure.ADV_TOEnable = DISABLE;
 135   1        ADV_InitStructure.ADV_Run = DISABLE;     // disable adv.
 136   1      
 137   1        BLE_ADV_Cmd(&ADV_InitStructure);
 138   1      
 139   1        //禁止0.5秒定时
 140   1        Twor05Timer(DISABLE);
 141   1      
 142   1        En_P30_Wakeup_Init();
 143   1      
 144   1        //使能P3.0的外部中断
 145   1        En_P30_Wakeup_Enable();
 146   1        
 147   1      
 148   1          //休眠
 149   1          BLE_AutoPwrDown_Enable();
 150   1          //clock 16M -> 8M
 151   1        
 152   1          PCON |= 0x01;
 153   1      }
 154          
 155          /* 使能外部唤醒中断 */
 156          void En_P30_Wakeup_Enable(void)
 157          {
 158   1          P3WUN &= ~0x01;   // P3_0 ,Enable wakeup
 159   1          EIE |= 0x10;        // 打开外部中断
 160   1      }
 161          
 162          /* 初始化外部唤醒 */
 163          void En_P30_Wakeup_Init(void)
 164          {
 165   1              //p3_1    -- 降低功耗
 166   1              P3OE &= ~0x02; // P3.1为输入
 167   1          P3PUN &= ~0x02; // P3.1为上拉
 168   1              P3 &= ~0x02;    // P3.1为低电平
 169   1          
 170   1          IOSEL &=~0x01;    // P3_1 use for normal IO
 171   1          P3OE &=~0x01;
 172   1          P3PUN &=~0x01;    // P3_1 pull up
 173   1        
 174   1          P3 |= 0x01;
 175   1        
 176   1        //      PCONE   &= ~0xc0;
 177   1          PCONE  |= 0x80;    // rising edge interrupt
C51 COMPILER V9.00   MCUFUNCTION                                                           07/12/2019 22:42:47 PAGE 4   

 178   1      
 179   1          EIF |= 0x10;    // CLR KEYINT FLAG
 180   1      }
 181          
 182          void initIsr_timer1(void)
 183          {
 184   1          CKCON=(CKCON&0xef)|0x10;//set timer1 clock
 185   1          TMOD=(TMOD&0x0F)|0x20;//timer1,mode2
 186   1      //  TH0 = 56; //100us
 187   1      //  TL0 = 56;
 188   1          TH1 = 56;
 189   1          TL1 = 56;
 190   1          TF1 = 0; // Clear any pending Timer1 interrupts
 191   1          ET1 = 1; // Enable Timer1 interrupt
 192   1          TR1 = 0;//timer0 enable
 193   1      }
 194          
 195          void enable_timer1(void)
 196          {
 197   1        ET1 = 1; // Enable Timer1 interrupt
 198   1          TR1 = 1;//timer1 enable
 199   1      }
 200          
 201          void disable_timer1(void)
 202          {
 203   1          ET1 = 0;  // Disable Timer1 interrupt
 204   1          TR1 = 0;  // timer1 stop
 205   1      }
 206          
 207          /*********************************************************************
 208          **  Prcss_Key
 209          *********************************************************************/
 210          #ifdef _PROFILE_TAOBAO_
              void Prcss_Weight(void)
              {
                uint8_t i,result,tmp;
                    
                switch(scale_index)
                {
                    case 0x00:
                        for(i=0;i<20;i++)
                            att_HDL_TAOBAO_DATI[i] = send_scale_data[i];
                            
                        att_HDL_TAOBAO_DATI[10]=scalebuf[0];
                        scalebuf[0]++;
              P0_1 = ~P0_1;
                        result = BLE_SendData(att_HDL_TAOBAO_DATI,ATT_HDL_TAOBAO_DATI_INIT,20);
                        if(result == SUCCESS)
                          scale_index++;                      
                        break;
              
                    case 0x01:
                        for(i=0;i<20;i++)
                            att_HDL_TAOBAO_DATI[i] = send_scale_data[i+20];
                        att_HDL_TAOBAO_DATI[1]=scalebuf[1];
                        att_HDL_TAOBAO_DATI[2]=scalebuf[2];
                        att_HDL_TAOBAO_DATI[3]=scalebuf[3];
                        att_HDL_TAOBAO_DATI[4]=scalebuf[4];
                        att_HDL_TAOBAO_DATI[8]=scalebuf[5];
                        att_HDL_TAOBAO_DATI[9]=scalebuf[6];
                        att_HDL_TAOBAO_DATI[10]=scalebuf[7];
                        att_HDL_TAOBAO_DATI[11]=scalebuf[8];
C51 COMPILER V9.00   MCUFUNCTION                                                           07/12/2019 22:42:47 PAGE 5   

                        att_HDL_TAOBAO_DATI[12]=scalebuf[9];
              
                        result = BLE_SendData(att_HDL_TAOBAO_DATI,ATT_HDL_TAOBAO_DATI_INIT,20);
                        if(result == SUCCESS)
                        {
              
                          weightvalue = weightvalue+100;
              
                          tmp=toascii(weightvalue,3);
                          scalebuf[1]=tmp;
                          tmp=toascii(weightvalue,2);
                          scalebuf[2]=tmp;            
                          tmp=toascii(weightvalue,1); 
                          scalebuf[3]=tmp;            
                          tmp=toascii(weightvalue,0);
                          scalebuf[4]=tmp;
                          
                          datevalue = datevalue+100;
                          tmp=toascii(datevalue,4);
                          scalebuf[5]=tmp;
                          tmp=toascii(datevalue,3);
                          scalebuf[6]=tmp;            
                          tmp=toascii(datevalue,2);
                          scalebuf[7]=tmp;            
                          tmp=toascii(datevalue,1);
                          scalebuf[8]=tmp;            
                          tmp=toascii(datevalue,0);
                          scalebuf[9]=tmp;  
                                    
                          scale_index++;
                        }
                        break;
                                    
                    case 0x02:
                        for(i=0;i<20;i++)
                            att_HDL_TAOBAO_DATI[i] = send_scale_data[i+20+20];
                        result = BLE_SendData(att_HDL_TAOBAO_DATI,ATT_HDL_TAOBAO_DATI_INIT,20);
                        if(result == SUCCESS)
                        {
                          scale_index++;
                          KeyWakeup = 0;
                        }
                        break;
              
                    default:
                        break;
                }                                 
              
              }
              #endif
 290          /*********************************************************************
 291          **  toascii
 292          *********************************************************************/
 293          uint8_t toascii(uint32_t in, uint8_t unit)
 294          {
 295   1        uint8_t tmp;
 296   1      
 297   1        tmp = ascii[(in>>(unit*4))&0x0F];
 298   1        return tmp;
 299   1      }
 300          
 301          /////////////////TWOR//////////////////////////////////////////////
C51 COMPILER V9.00   MCUFUNCTION                                                           07/12/2019 22:42:47 PAGE 6   

 302          /*********************************************************************
 303          **  Enable05Timer
 304          *********************************************************************/
 305          void Twor05Timer(uint8_t TimerEnable)
 306          {
 307   1        if(TimerEnable == ENABLE)
 308   1        {
 309   2          TworTimer=1;
 310   2          A8107_RCSelect(internalRC);
 311   2          //XBYTE[GIO2_REG]=0x10;
 312   2          XBYTE[RCOSC1_REG]=0x1F;
 313   2          XBYTE[CKO_REG]=0x52;
 314   2          XBYTE[VCOC_REG]=0xE0;
 315   2          //EIE = EIE | 0x08;
 316   2        }
 317   1        else
 318   1        {
 319   2          TworTimer=0;
 320   2          A8107_RCSelect(internalRC);
 321   2          XBYTE[CKO_REG]=0x52;
 322   2        }
 323   1      }
 324          //////////////////TWOR///////////////////////////////////////////////


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    262    ----
   CONSTANT SIZE    =     60    ----
   XDATA SIZE       =     42      14
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
